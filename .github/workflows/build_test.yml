name: Build & Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build_test_i386:
    name: Build & Test i386
    runs-on: ubuntu-latest
    container: 
      image: i386/ubuntu:latest

    steps:
    # actions/checkout@v3 doesn't work in a i386 container: the GitHub runner
    # uses `node` that is installed on the host inside the container. The host
    # is (likely) running x86_64 and using a binary build for x86_64 inside a
    # i386 container just doesn't work.
    - uses: actions/checkout@v1

    - name: Build
      run: cargo build --release

    - name: Test
      run: cargo test --release

  # build_test_x86:
  #   name: Build & Test X86
  #   runs-on: ubuntu-latest

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Build
  #     run: cargo build --release

  #   - name: Test
  #     run: cargo test --release

  # build_test_x86_avx2:
  #   name: Build & Test X86 AVX2
  #   runs-on: ubuntu-latest

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Switch to nightly rust
  #     run: rustup default nightly

  #   - name: Build
  #     run: cargo build --release

  #   - name: Test
  #     run: cargo test --release

  # build_test_arm:
  #   name: Build & Test ARM
  #   runs-on: buildjet-2vcpu-ubuntu-2204-arm

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Build
  #     run: cargo build --release

  #   - name: Test
  #     run: cargo test --release