name: Benchmark

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark-x86:
    name: Benchmark X86
    runs-on: buildjet-2vcpu-ubuntu-2204

    steps:
    - uses: actions/checkout@v4

    - name: Benchmark
      run: cargo bench --bench throughput --features 'bench-plot'

    - name: Switch to nightly rust
      run: rustup default nightly

    - name: Benchmark AVX2 (nightly)
      run: cargo bench --bench throughput --features 'bench-plot avx2'

    - uses: actions/upload-artifact@v3
      with:
        name: benches-x86
        path: benches/throughput/*.svg

  benchmark-arm:
    name: Benchmark ARM
    runs-on: buildjet-2vcpu-ubuntu-2204-arm

    steps:
    - uses: actions/checkout@v4

    - name: Benchmark
      run: cargo bench --bench throughput --features 'bench-plot'

    - uses: actions/upload-artifact@v3
      with:
        name: benches-arm
        path: benches/throughput/*.svg

  commit:
    name: Commit & Push
    runs-on: ubuntu-latest
    needs: [benchmark-x86, benchmark-arm]

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download ARM Benchmark Results
      uses: actions/download-artifact@v3
      with:
        name: benches-arm
        path: benches/throughput

    - name: Download X86 Benchmark Results
      uses: actions/download-artifact@v3
      with:
        name: benches-x86
        path: benches/throughput

    - name: Commit & Push Plots
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: Update Benchmark Plots
        file_pattern: '*.svg'
        commit_user_name: Benchmark Bot
        commit_user_email: benchmark-bot@noreply.com
        commit_author: Benchmark Bot <benchmark-bot@noreply.com>
      